{"updatedAt":"2025-08-04T16:48:27.233Z","createdAt":"2025-08-04T16:48:17.851Z","id":"vH1ipPKbjspgR9Qf","name":"order-and-delivery-support","active":false,"isArchived":false,"nodes":[{"parameters":{"model":"gpt-4o","options":{"topP":0.5}},"id":"d53f74a5-aeac-4eed-8fb1-4c7bc634cde6","name":"OpenAI Chat Model","type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1,"position":[-180,320]},{"parameters":{"model":"gpt-4o","options":{}},"id":"0668a1b2-9697-4573-8087-5f46e9f6fe22","name":"OpenAI Chat Model1","type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1,"position":[920,500]},{"parameters":{"jsonMode":"expressionData","jsonData":"={{ $json.data }}","options":{"metadata":{"metadataValues":[{"name":"=file_id","value":"={{ $('Set File ID').item.json.file_id }}"}]}}},"id":"4ffa739f-0bf1-46a6-9e51-50b1482d5dc6","name":"Default Data Loader","type":"@n8n/n8n-nodes-langchain.documentDefaultDataLoader","typeVersion":1,"position":[980,1260]},{"parameters":{"model":"text-embedding-3-small","options":{}},"id":"9ab85fb5-0bc1-46e3-8d96-b12670125816","name":"Embeddings OpenAI1","type":"@n8n/n8n-nodes-langchain.embeddingsOpenAi","typeVersion":1,"position":[820,1260]},{"parameters":{"name":"documents","description":" Whenever customer asks questions about our services, you HAVE TO use the tool."},"id":"d46ad4e2-fe61-4a60-b8a5-7c65fa05c00b","name":"Retrieve Documents","type":"@n8n/n8n-nodes-langchain.toolVectorStore","typeVersion":1,"position":[700,320]},{"parameters":{"content":"## Tool to Add a Google Drive File to Vector DB","height":758,"width":1471,"color":2},"id":"256f3048-0c25-417e-8213-95130fc87abe","name":"Sticky Note1","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-220,860]},{"parameters":{"operation":"download","fileId":{"__rl":true,"value":"={{ $('Set File ID').item.json.file_id }}","mode":"id"},"options":{"googleFileConversion":{"conversion":{"docsToFormat":"text/plain"}}}},"id":"d9fbac45-c326-423b-ae82-959364aef562","name":"Download File","type":"n8n-nodes-base.googleDrive","typeVersion":3,"position":[460,1040],"executeOnce":true},{"parameters":{"pollTimes":{"item":[{"mode":"everyMinute"}]},"triggerOn":"specificFolder","folderToWatch":{"__rl":true,"value":"1TsAZucMy1ame6wNyYuIDK9da0e71mYhv","mode":"list","cachedResultName":"Order and Delivery Support","cachedResultUrl":"https://drive.google.com/drive/folders/1TsAZucMy1ame6wNyYuIDK9da0e71mYhv"},"event":"fileCreated","options":{}},"id":"4efa5d6f-7f4a-4d9a-b2e4-f21134fc1935","name":"File Created","type":"n8n-nodes-base.googleDriveTrigger","typeVersion":1,"position":[-140,940]},{"parameters":{"pollTimes":{"item":[{"mode":"everyMinute"}]},"triggerOn":"specificFolder","folderToWatch":{"__rl":true,"value":"1TsAZucMy1ame6wNyYuIDK9da0e71mYhv","mode":"list","cachedResultName":"Order and Delivery Support","cachedResultUrl":"https://drive.google.com/drive/folders/1TsAZucMy1ame6wNyYuIDK9da0e71mYhv"},"event":"fileUpdated","options":{}},"id":"23cd01b8-9d9a-41e6-895c-57b0f165176d","name":"File Updated","type":"n8n-nodes-base.googleDriveTrigger","typeVersion":1,"position":[-140,1160]},{"parameters":{"operation":"text","options":{}},"id":"dc12accc-fa99-41fe-864e-d04be972e915","name":"Extract Document Text","type":"n8n-nodes-base.extractFromFile","typeVersion":1,"position":[640,1040],"alwaysOutputData":true},{"parameters":{"model":"text-embedding-3-small","options":{}},"id":"a1a18c83-f392-4ad6-853b-bacf86f55078","name":"Embeddings OpenAI","type":"@n8n/n8n-nodes-langchain.embeddingsOpenAi","typeVersion":1,"position":[760,620]},{"parameters":{},"id":"d7671711-f2fb-4d37-a956-54e55f83ee99","name":"Postgres Chat Memory","type":"@n8n/n8n-nodes-langchain.memoryPostgresChat","typeVersion":1,"position":[-20,320],"notesInFlow":false},{"parameters":{"chunkOverlap":500,"options":{}},"id":"9716cccf-2c55-4dd3-a980-fd1d370ad6bd","name":"Recursive Character Text Splitter","type":"@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter","typeVersion":1,"position":[980,1460]},{"parameters":{"operation":"delete","tableId":"documents","filterType":"string","filterString":"=metadata->>file_id=like.*{{ $json.file_id }}*"},"id":"c653b583-c140-4aaa-a6b7-a56c2cb323fb","name":"Delete Old Doc Rows","type":"n8n-nodes-base.supabase","typeVersion":1,"position":[280,1040],"alwaysOutputData":true},{"parameters":{"assignments":{"assignments":[{"id":"10646eae-ae46-4327-a4dc-9987c2d76173","name":"file_id","value":"={{ $json.id }}","type":"string"}]},"options":{}},"id":"853434d5-6e09-4027-b290-16d750987149","name":"Set File ID","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[120,1040]},{"parameters":{"public":true,"options":{}},"id":"4f9f4ac4-9789-49cb-8b7c-80e1df137ea3","name":"When chat message received","type":"@n8n/n8n-nodes-langchain.chatTrigger","typeVersion":1.1,"position":[0,0],"webhookId":"5caca78f-1b6c-4b8b-9917-06fe7c17bc38"},{"parameters":{"tableName":{"__rl":true,"value":"documents","mode":"list","cachedResultName":"documents"},"options":{"queryName":"match_documents"}},"id":"644ab239-b875-4993-8653-8940d18949f6","name":"Supabase Vector Store","type":"@n8n/n8n-nodes-langchain.vectorStoreSupabase","typeVersion":1,"position":[560,480]},{"parameters":{"mode":"insert","tableName":{"__rl":true,"value":"documents","mode":"list","cachedResultName":"documents"},"options":{"queryName":"match_documents"}},"id":"0412029a-c848-4c1c-8f0b-c8f1536ed6a9","name":"Insert into Supabase Vectorstore","type":"@n8n/n8n-nodes-langchain.vectorStoreSupabase","typeVersion":1,"position":[860,1040]},{"parameters":{"descriptionType":"manual","toolDescription":"=Use tool when:\nClient faces a problem and needs help of support team.\n\nIMPORTANT:\nBefore using the \"Create Ticket\" use tool \"Search Order\" and make sure order exists in database. If not - don't use it.","operation":"create","base":{"__rl":true,"value":"appaP2ScdRHohGtfZ","mode":"list","cachedResultName":"Delivery Service Management","cachedResultUrl":"https://airtable.com/appaP2ScdRHohGtfZ"},"table":{"__rl":true,"value":"tblRnjvjYvZVmS2cY","mode":"list","cachedResultName":"Inquiries","cachedResultUrl":"https://airtable.com/appaP2ScdRHohGtfZ/tblRnjvjYvZVmS2cY"},"columns":{"mappingMode":"defineBelow","value":{"Inquiry Reason":"={{ $fromAI(\"inquiry_reason\",\"Inquiry Reason \",\"string\") }}","Inquiry Type":"={{ $fromAI(\"inquiry_type\",\"Inquiry Type. Must be either 'Issue' or 'Return' \",\"string\") }}","Status":"In Process","Details":"={{ $fromAI(\"inquiry_details\",\"Inquiry Details \",\"string\") }}","Order":"={{ [$fromAI(\"tracking_number\",\"tracking number. Must be provided by client \",\"string\") ]}}"},"matchingColumns":[],"schema":[{"id":"Inquiry Reason","displayName":"Inquiry Reason","required":false,"defaultMatch":false,"canBeUsedToMatch":true,"display":true,"type":"string","readOnly":false,"removed":false},{"id":"Inquiry Type","displayName":"Inquiry Type","required":false,"defaultMatch":false,"canBeUsedToMatch":true,"display":true,"type":"options","options":[{"name":"Return","value":"Return"},{"name":"Issue","value":"Issue"}],"readOnly":false,"removed":false},{"id":"Status","displayName":"Status","required":false,"defaultMatch":false,"canBeUsedToMatch":true,"display":true,"type":"options","options":[{"name":"Resolved","value":"Resolved"},{"name":"In Process","value":"In Process"}],"readOnly":false,"removed":false},{"id":"Details","displayName":"Details","required":false,"defaultMatch":false,"canBeUsedToMatch":true,"display":true,"type":"string","readOnly":false,"removed":false},{"id":"Order","displayName":"Order","required":false,"defaultMatch":false,"canBeUsedToMatch":true,"display":true,"type":"array","readOnly":false,"removed":false},{"id":"Client Feedback","displayName":"Client Feedback","required":false,"defaultMatch":false,"canBeUsedToMatch":true,"display":true,"type":"string","readOnly":false,"removed":false}]},"options":{"typecast":true}},"type":"n8n-nodes-base.airtableTool","typeVersion":2.1,"position":[260,320],"id":"902f2f90-bf13-4a89-97aa-fc729e7d1060","name":"Create Ticket"},{"parameters":{"descriptionType":"manual","toolDescription":"=Use tool when:\n1. Customer wants to create a ticket. In this case we need to make sure order exists.\n2. Customer wants to track his order.\n3. Customer wants to set a call with team. In this case we need to make sure order exists and confirm client email for the call. Email is in field \"Customer Email\"","operation":"search","base":{"__rl":true,"value":"appaP2ScdRHohGtfZ","mode":"list","cachedResultName":"Delivery Service Management","cachedResultUrl":"https://airtable.com/appaP2ScdRHohGtfZ"},"table":{"__rl":true,"value":"tblj2ZymzvP7hQ5RK","mode":"list","cachedResultName":"Orders","cachedResultUrl":"https://airtable.com/appaP2ScdRHohGtfZ/tblj2ZymzvP7hQ5RK"},"filterByFormula":"=AND({Tracking Number}='{{ [$fromAI(\"tracking_number\",\"tracking number. Must be provided by client \",\"string\") ]}}',{Status}!='Delivered')","returnAll":false,"limit":1,"options":{"fields":["Current Location","Status","Estimated Delivery Time","Customer","Customer Email"]}},"type":"n8n-nodes-base.airtableTool","typeVersion":2.1,"position":[120,320],"id":"8121b80d-da19-4405-b7c9-51c1e933289b","name":"Search Order"},{"parameters":{"name":"Get_Slots","description":"=Use tool to find out free meeting slots. \nCall it every time client ask to set a call with support team.\nBefore using the tool you need to use \"Search Order\" to make sure order exists.\nBefore using the tool client must provide you with desired date for the call.\n\nInput:\nchosen_date - \"2024-12-14\"\n\nOutput:\nList of dates\n{\"start\": \n\"17/12/2024, 08:00:00\",\n\"end\": \n\"17/12/2024, 14:00:00\"}","workflowId":{"__rl":true,"value":"KhCWJyXtfHZt2yJq","mode":"list","cachedResultName":"Order and Delivery Support"}},"id":"0cab672f-3fb6-4425-aa5c-d226848c599b","name":"Get Slots","type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":1.2,"position":[400,320]},{"parameters":{"descriptionType":"manual","toolDescription":"=Create Google Calendar Event.\n\nInput Example:\nStart Date Time - \"17/12/2024, 08:00:00\"\nEnd Date - \"17/12/2024, 14:00:00\"\nemail - \"philippbekher@gmail.com\"\n\nIMPORTANT:\n- When you create event - don't send back event link.\n\nVERY IMPORTANT:\n- We need to use client's email to book a call. Before scheduling call we use airtable tool \"Search Order\" to make sure order exists. If order indeed exists, order record from airtable will contain field \"Customer Email\" which can be used for Attendee email. Anyway, it's important to confirm with client.\n\nVERY IMPORTANT: Always ask client to confirm an email for the meeting.","calendar":{"__rl":true,"value":"philipp@lowcoding.dev","mode":"list","cachedResultName":"philipp@lowcoding.dev"},"start":"={{ $fromAI(\"start_date_time\",\"Date and time of meeting start\",\"string\") }}","end":"={{ $fromAI(\"end_date_time\",\"Date and time of meeting end\",\"string\") }}","additionalFields":{"attendees":["={{ $fromAI(\"email\",\"Client email. Usually goes in order airtable record, but it's better to confirm it with client \",\"string\") }}"],"conferenceDataUi":{"conferenceDataValues":{"conferenceSolution":"hangoutsMeet"}},"summary":"={{ $fromAI(\"meeting_name\",\"Meeting name\",\"string\") }}"}},"id":"a5f7de13-6be4-4b1c-97fc-082f4565df66","name":"Schedule Call","type":"n8n-nodes-base.googleCalendarTool","typeVersion":1.2,"position":[540,320]},{"parameters":{"agent":"openAiFunctionsAgent","promptType":"define","text":"={{ $('When chat message received').item.json.chatInput }}","options":{"systemMessage":"=You are a personal assistant at delivery service company.\n1. You help answer questions about our services with knowledge base.\nIMPORTANT: \nWhen providing answer - ask customer if his problem was resolved and remind we can create support ticket or set up a call if it's urgent.\n\n2. You process customers' inquiries: you'll create support tickets in database, set up calls with support team and help track packages.\n\nToday is: {{ $now }}"}},"id":"aaaad04a-bf57-48a8-b2fa-ac15a59fa8f5","name":"AI Agent","type":"@n8n/n8n-nodes-langchain.agent","typeVersion":1.6,"position":[180,0]},{"parameters":{},"id":"55d19146-4579-46a4-bea4-b904f64bbf1c","name":"Execute Workflow Trigger","type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1,"position":[-120,1780]},{"parameters":{"operation":"getAll","calendar":{"__rl":true,"value":"philipp@lowcoding.dev","mode":"list","cachedResultName":"philipp@lowcoding.dev"},"returnAll":true,"options":{"timeMin":"={{ $json.StartOfDay }}","timeMax":"={{ $json.endOfDay }}","singleEvents":true}},"id":"fc52f5a6-7986-4944-b1e4-94de02015b08","name":"Google Calendar Events","type":"n8n-nodes-base.googleCalendar","position":[300,1780],"typeVersion":1,"alwaysOutputData":true},{"parameters":{"jsCode":"// Define dynamic start and end of the day\nconst startOfDay = new Date($(\"Set Start/End of Day\").first().json.StartOfDay)\nconst endOfDay = new Date($(\"Set Start/End of Day\").first().json.endOfDay)\n\n// Parse all input events\nconst events = $(\"Google Calendar Events\").all().map(item => ({\n  start: new Date(item.json.start.dateTime),\n  end: new Date(item.json.end.dateTime)\n}));\n\n// Sort events by start time\nevents.sort((a, b) => a.start - b.start);\n\n// Initialize free slots\nconst freeSlots = [];\nlet lastEnd = startOfDay;\n\n// Berlin time zone formatting options\nconst berlinOptions = { timeZone: 'Europe/Berlin', hour12: false };\n\n// Function to convert to Berlin time\nconst toBerlinTime = (date) => {\n  return new Date(date).toLocaleString('en-GB', berlinOptions);\n};\n\nfor (const event of events) {\n  const eventStart = new Date(event.start);\n  const eventEnd = new Date(event.end);\n\n  // If there's a gap between the last end time and this event's start time, add it as a free slot\n  if (eventStart > lastEnd) {\n    freeSlots.push({\n      start: toBerlinTime(lastEnd),  // Convert start time to Berlin time\n      end: toBerlinTime(eventStart)  // Convert end time to Berlin time\n    });\n  }\n\n  // Update the last end time to the later of the two\n  lastEnd = new Date(Math.max(lastEnd, eventEnd));\n}\n\n// Add the final free slot if there's free time after the last event until end of day\nif (lastEnd < endOfDay) {\n  freeSlots.push({\n    start: toBerlinTime(lastEnd),  // Convert start time to Berlin time\n    end: toBerlinTime(endOfDay)    // Convert end time to Berlin time\n  });\n}\n\n// Return the free slots array\nreturn freeSlots;\n"},"id":"810bcaa7-00fb-4bcc-97d8-18117def723b","name":"Get Free Slots","type":"n8n-nodes-base.code","typeVersion":2,"position":[540,1780],"alwaysOutputData":true},{"parameters":{"assignments":{"assignments":[{"id":"47aff83f-5e93-42f1-93dd-7e021f2b97ab","name":"=StartOfDay","value":"={{ \n  DateTime.fromFormat($json.query, \"yyyy-MM-dd\")\n    .hasSame(DateTime.local(), 'day') \n    ? DateTime.local().plus({ hours: 1 }).toISO() \n    : DateTime.fromFormat($json.query, \"yyyy-MM-dd\").startOf('day').toISO() \n}}","type":"object"},{"id":"788ea912-4b75-41ea-8941-168668275006","name":"endOfDay","value":"={{ \n  DateTime.fromFormat($json.query, \"yyyy-MM-dd\")\n    .plus({ days: 1 })\n    .startOf('day')\n    .toISO() \n}}","type":"object"}]},"options":{"ignoreConversionErrors":true}},"id":"5bd10277-aa0f-4fea-846d-7491374d663b","name":"Set Start/End of Day","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[100,1780]},{"parameters":{"operation":"concatenateItems","aggregate":"aggregateAllItemData","destinationFieldName":"response","include":"allFieldsExcept","options":{}},"id":"e64d5c4c-b876-40f0-a568-f6e145c205d4","name":"Set Response","type":"n8n-nodes-base.itemLists","position":[800,1780],"typeVersion":3},{"parameters":{"content":"## Calculate Free Slots\n","height":298,"width":1251,"color":2},"id":"1861d8d1-6329-4068-97e4-d6789480791b","name":"Sticky Note","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-220,1700]}],"connections":{"OpenAI Chat Model":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"OpenAI Chat Model1":{"ai_languageModel":[[{"node":"Retrieve Documents","type":"ai_languageModel","index":0}]]},"Retrieve Documents":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"Download File":{"main":[[{"node":"Extract Document Text","type":"main","index":0}]]},"File Created":{"main":[[{"node":"Set File ID","type":"main","index":0}]]},"Embeddings OpenAI":{"ai_embedding":[[{"node":"Supabase Vector Store","type":"ai_embedding","index":0}]]},"Extract Document Text":{"main":[[{"node":"Insert into Supabase Vectorstore","type":"main","index":0}]]},"Embeddings OpenAI1":{"ai_embedding":[[{"node":"Insert into Supabase Vectorstore","type":"ai_embedding","index":0}]]},"Default Data Loader":{"ai_document":[[{"node":"Insert into Supabase Vectorstore","type":"ai_document","index":0}]]},"Postgres Chat Memory":{"ai_memory":[[{"node":"AI Agent","type":"ai_memory","index":0}]]},"Recursive Character Text Splitter":{"ai_textSplitter":[[{"node":"Default Data Loader","type":"ai_textSplitter","index":0}]]},"Delete Old Doc Rows":{"main":[[{"node":"Download File","type":"main","index":0}]]},"Set File ID":{"main":[[{"node":"Delete Old Doc Rows","type":"main","index":0}]]},"File Updated":{"main":[[{"node":"Set File ID","type":"main","index":0}]]},"When chat message received":{"main":[[{"node":"AI Agent","type":"main","index":0}]]},"Supabase Vector Store":{"ai_vectorStore":[[{"node":"Retrieve Documents","type":"ai_vectorStore","index":0}]]},"Create Ticket":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"Search Order":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"Get Slots":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"Schedule Call":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"Execute Workflow Trigger":{"main":[[{"node":"Set Start/End of Day","type":"main","index":0}]]},"Google Calendar Events":{"main":[[{"node":"Get Free Slots","type":"main","index":0}]]},"Get Free Slots":{"main":[[{"node":"Set Response","type":"main","index":0}]]},"Set Start/End of Day":{"main":[[{"node":"Google Calendar Events","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"versionId":"0874dec5-6d9d-4237-9d61-2f7096f8fcf6","triggerCount":0,"shared":[{"updatedAt":"2025-08-04T16:48:17.851Z","createdAt":"2025-08-04T16:48:17.851Z","role":"workflow:owner","workflowId":"vH1ipPKbjspgR9Qf","projectId":"zwyEtHn1PnfmNkEl"}],"tags":[]}