{"updatedAt":"2025-11-04T06:14:40.425Z","createdAt":"2025-11-03T17:21:59.018Z","id":"mzwBsES6SDvv2kOp","name":"fedsfm_parsing","active":false,"isArchived":false,"nodes":[{"parameters":{"jsCode":"const axios = require('axios');\nconst cheerio = require('cheerio');\nconst https = require('https');\n\n// ONE-OFF agent that does NOT validate the certificate\nconst unsafeAgent = new https.Agent({ rejectUnauthorized: false });\n\nconst url = 'https://www.fedsfm.ru/documents/terrorists-catalog-portal-act';\nconst { data: html } = await axios.get(url, {\n  timeout: 30000,\n  headers: { 'User-Agent': 'Mozilla/5.0' },\n  httpsAgent: unsafeAgent          // <-- disables cert check\n});\n\nconst $ = cheerio.load(html);\nconst orgs = [];\nconst persons = [];\n\n$('ol.terrorist-list li').each((_, el) => {\n  const raw = $(el).text().trim();\n  const m = raw.match(/^(\\d+)\\.\\s*(.+)/s);\n  if (!m) return;\n\n  const num  = parseInt(m[1], 10);\n  const body = m[2].trim();\n\n  if (/\\d{2}\\.\\d{2}\\.\\d{4}\\s+г\\.р\\./.test(body)) {\n    const nameM = body.match(/^([А-ЯЁ\\s]+)\\*?/);\n    const fullName = nameM ? nameM[1].trim() : '';\n    const dateM = body.match(/(\\d{2}\\.\\d{2}\\.\\d{4})/);\n    const birthDate = dateM ? dateM[1] : null;\n    const locM = body.match(/г\\.р\\.\\s*,\\s*([^;]+)/);\n    const location = locM ? locM[1].trim() : null;\n    persons.push({ type: 'person', number: num, name: fullName, full_name: fullName, birth_date: birthDate, location });\n  } else {\n    const nameM = body.match(/^([^(,]+)/);\n    const mainName = nameM ? nameM[1].replace(/\\*/g, '').trim() : '';\n    orgs.push({ type: 'organization', number: num, name: mainName, full_name: mainName });\n  }\n});\n\nreturn [{ json: { organizations: orgs, persons: persons, total: orgs.length + persons.length, org_count: orgs.length, person_count: persons.length } }];"},"id":"db09213f-aac2-44a0-be84-fd5bd06ffeac","name":"Parse Terrorist List","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1000,100]},{"parameters":{"jsCode":"const data = $input.first().json;\nconst all = [ ...(data.organizations || []), ...(data.persons || []) ];\nconst batchSize = 100;\nconst batches = [];\n\nfor (let i = 0; i < all.length; i += batchSize) {\n  const slice = all.slice(i, i + batchSize);\n  batches.push({\n    batch_number: Math.floor(i / batchSize) + 1,\n    batch_size: slice.length,\n    names: slice.map(e => e.name || e.full_name)\n  });\n}\n\nreturn batches.map(b => ({ json: b }));"},"id":"b9886acf-3749-4def-8264-4d57eda2fcd2","name":"Create Batches (100 names each)","type":"n8n-nodes-base.code","typeVersion":2,"position":[-800,100]},{"parameters":{"method":"POST","url":"http://localhost:5000/api/batch-search","authentication":"headerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"X-API-Key","value":"your_api_key_here"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"names\": {{$json.names}},\n  \"type\": \"all\",             // or \"person\"/\"organization\" if needed\n  \"parallel_workers\": 5      // or 10, depending on your backend config\n}\n","options":{}},"id":"25715b7a-1dd6-4a0e-895b-09735342c338","name":"Batch API Search (100 names)","type":"n8n-nodes-base.httpRequest","typeVersion":4,"position":[-540,100]},{"parameters":{"jsCode":"const res = $input.first().json;\nconst summary = {\n  batch_number: res.batch_number || 'X',\n  batch_size: res.batch_size,\n  found_count: res.found_count || 0,\n  not_found_count: res.not_found_count || 0,\n  response_time_ms: res.response_time_ms || 0,\n  timestamp: new Date().toISOString()\n};\n\nconst matches = [];\nif (res.results) {\n  for (const [name, data] of Object.entries(res.results)) {\n    if (data.found) {\n      matches.push({\n        name,\n        match_level: data.match_level || data.stage || \"unknown\",   // <--- KEY LINE\n        result_count: (data.results || []).length,\n        results: data.results\n      });\n    }\n  }\n}\nreturn [{ json: { summary, matches, total_matches: matches.length } }];\n"},"id":"1804d01f-4742-4946-96e4-c54e70464f26","name":"Process Batch Results","type":"n8n-nodes-base.code","typeVersion":2,"position":[-320,100]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"c1","leftValue":"={{$json.total_matches}}","rightValue":0,"operator":{"operation":">","type":"number","singleValue":true}}],"combinator":"AND"},"options":{}},"id":"5ff4694f-85b0-447b-8597-4d8187dd0fbf","name":"Has Matches?","type":"n8n-nodes-base.if","typeVersion":2,"position":[-80,100]},{"parameters":{"jsCode":"const batch = $input.first().json;\nreturn [{ json: {\n  match_alert: true,\n  batch_info: batch.summary,\n  matches: batch.matches,\n  alert_message: `Found ${batch.total_matches} matches in batch. Details: ${JSON.stringify(batch.matches).substring(0, 500)}...`,\n  timestamp: new Date().toISOString()\n} }];"},"id":"f35e02d7-8dc0-4930-b0bd-b5191fa953af","name":"Alert on Match","type":"n8n-nodes-base.code","typeVersion":2,"position":[160,0]},{"parameters":{"jsCode":"return [{ json: { no_matches: true, timestamp: new Date().toISOString() } }];"},"id":"f511bb30-adec-4c29-a942-193642db224e","name":"No Match - Continue","type":"n8n-nodes-base.code","typeVersion":2,"position":[140,220]},{"parameters":{},"type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[-1220,120],"id":"b5b8a084-f05b-49ee-abba-b0f31d27e3f6","name":"When clicking ‘Execute workflow’"},{"parameters":{"content":"CREATE TABLE IF NOT EXISTS user_checks (\n    id SERIAL PRIMARY KEY,\n    chat_id BIGINT NOT NULL,\n    checked_entry_id INT REFERENCES terrorist_entries(id),\n    check_type VARCHAR(20),          -- 'person' or 'organization'\n    user_input TEXT,                 -- raw user input/action/body\n    percent_match REAL,              -- e.g. 0.85 for 85% match\n    match_level VARCHAR(20),         -- 'exact', 'partial', 'fuzzy'\n    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    UNIQUE(chat_id, checked_entry_id)\n);\n\nCREATE INDEX idx_user_checks_chat_id ON user_checks(chat_id);\nCREATE INDEX idx_user_checks_entry_id ON user_checks(checked_entry_id);\n","height":380,"width":560},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-1260,-460],"id":"b938fb6a-c323-4784-aa12-1f6fb8f10b05","name":"Sticky Note"},{"parameters":{"content":"When a user confirms a match in Telegram or your web interface, your bot should send (POST) to your backend’s API:\n\nAPI Endpoint:\n\n\nPOST /api/user-check\nContent-Type: application/json\nBody:\n{\n  \"chat_id\": 123456789,\n  \"checked_entry_id\": 9999,\n  \"percent_match\": 0.95,       // This is what user rates/you compute\n  \"match_level\": \"exact\",      // Copy from previous batch result\n  \"user_input\": \"User's explanation or context\"\n}","height":320,"width":540,"color":4},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[580,-400],"id":"9ee4ca68-efc4-4130-96f5-60e8012011ba","name":"Sticky Note1"},{"parameters":{"jsCode":"/* ---------- helper: Dice / Sørensen similarity ---------- */\nfunction stringSimilarity(a = '', b = '') {\n  if (!a || !b) return 0;\n  a = a.trim().toLowerCase();\n  b = b.trim().toLowerCase();\n  if (a === b) return 1;\n  if (a.length < 2 || b.length < 2) return 0;\n\n  const bigrams = s =>\n    Array.from({ length: s.length - 1 }, (_, i) => s.slice(i, i + 2));\n\n  const bgA = bigrams(a);\n  const bgB = bigrams(b);\n\n  let hits = 0;\n  const copy = [...bgB];          // mutate a copy\n  bgA.forEach(g => {\n    const idx = copy.indexOf(g);\n    if (idx !== -1) {\n      hits++;\n      copy.splice(idx, 1);        // count each bigram only once\n    }\n  });\n  return (2 * hits) / (bgA.length + bgB.length);\n}\n\n/* ---------- main: enrich every match with similarity ---------- */\nreturn $input.all().map(item => {\n  const json = item.json;\n\n  if (Array.isArray(json.matches)) {\n    json.matches = json.matches.map(match => {\n      if (!match.results || !match.results.length) return match;\n\n      // use first returned record as “found” name\n      const dbName = match.results[0].full_name || match.results[0].name || '';\n      const percent_match = stringSimilarity(match.name, dbName);\n\n      return { ...match, percent_match };   // attach score\n    });\n  }\n  return { json };\n});"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[380,0],"id":"7819fa19-fdec-407f-8181-0c2a9e904202","name":"Compute similarity"},{"parameters":{"operation":"sendAndWait","options":{}},"type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[580,0],"id":"1cbaad7f-3494-47b5-8cba-ae5e5609da7c","name":"Send message and wait for response","webhookId":"4faf7652-9b97-48df-b438-596f765fc44b","credentials":{"telegramApi":{"id":"WkhN45nAM0rbsZmf","name":"Telegram club"}}},{"parameters":{"rule":{"interval":[{"triggerAtHour":23}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-1240,-40],"id":"3ef12274-472b-4d4b-9f71-8e510cf81780","name":"Schedule Trigger"},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[-540,-160],"id":"4ddc7cd7-1111-4e6c-8944-9d125157cc5a","name":"Loop Over Items"}],"connections":{"Parse Terrorist List":{"main":[[{"node":"Create Batches (100 names each)","type":"main","index":0}]]},"Create Batches (100 names each)":{"main":[[]]},"Batch API Search (100 names)":{"main":[[{"node":"Process Batch Results","type":"main","index":0}]]},"Process Batch Results":{"main":[[{"node":"Has Matches?","type":"main","index":0}]]},"Has Matches?":{"main":[[{"node":"Alert on Match","type":"main","index":0}],[{"node":"No Match - Continue","type":"main","index":0}]]},"Alert on Match":{"main":[[{"node":"Compute similarity","type":"main","index":0}]]},"No Match - Continue":{"main":[[]]},"When clicking ‘Execute workflow’":{"main":[[{"node":"Parse Terrorist List","type":"main","index":0}]]},"Compute similarity":{"main":[[{"node":"Send message and wait for response","type":"main","index":0}]]},"Schedule Trigger":{"main":[[{"node":"Parse Terrorist List","type":"main","index":0}]]},"Loop Over Items":{"main":[[],[]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"versionId":"ab510c66-77bf-4a11-9d29-171135e05626","triggerCount":0,"shared":[{"updatedAt":"2025-11-03T17:21:59.018Z","createdAt":"2025-11-03T17:21:59.018Z","role":"workflow:owner","workflowId":"mzwBsES6SDvv2kOp","projectId":"zwyEtHn1PnfmNkEl"}],"tags":[]}
