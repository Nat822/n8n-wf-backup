{"updatedAt":"2025-10-17T07:59:06.251Z","createdAt":"2025-10-16T18:52:34.136Z","id":"tyHNs8a7QwP3Sdwv","name":"wf2_Payment Confirmation & Generation Start","active":false,"isArchived":false,"nodes":[{"parameters":{"path":"1defd86d-91d9-4a1a-8195-f37b950880ec","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,0],"id":"b5d65c0d-a4aa-44b4-9c08-a131688e4991","name":"Webhook","webhookId":"1defd86d-91d9-4a1a-8195-f37b950880ec"},{"parameters":{},"type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[0,-160],"id":"5c2aead8-9284-494a-bcbf-48ee6ef46ae6","name":"When clicking ‘Execute workflow’"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"8ffef89c-298d-4466-bf08-9b4a712d0512","leftValue":"","rightValue":"","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[220,-160],"id":"e08af719-762c-4363-b503-c46efda8e9b7","name":"If"},{"parameters":{"content":"if payment succeeded","height":100},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[160,-280],"id":"48b5fee8-2ac3-4aec-9448-08aebbfbb525","name":"Sticky Note"},{"parameters":{"operation":"executeQuery","query":"SELECT selected_character_id, user_text FROM user_sessions WHERE chat_id = {{ $json.body.object.metadata.chat_id }};","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[440,-260],"id":"ea9bd61d-25c1-4b76-8e7b-582112505b06","name":"Get All User Data","credentials":{"postgres":{"id":"WKBw7lOCAQDUE20p","name":"Postgres account"}}},{"parameters":{"chatId":"={{ $json.body.object.metadata.chat_id }}","text":"Оплата прошла успешно! Начинаю генерацию вашего видео. Это может занять несколько минут...","additionalFields":{}},"type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[660,-260],"id":"75ac97a2-6049-46da-85e9-b8e6becc0903","name":"Notify User","webhookId":"bbe8c2bc-e191-485b-b270-7f4f86411685","credentials":{"telegramApi":{"id":"FRssOlXEyxi0m4SO","name":"Telegram account"}}},{"parameters":{"method":"POST","url":"https://api.elevenlabs.io/v1/text-to-speech/voice_id(dynamicly)","authentication":"predefinedCredentialType","nodeCredentialType":"elevenLabsApi","sendBody":true,"specifyBody":"json","jsonBody":"{\n  \"text\": \"\",\n  \"model_id\": \"eleven_multilingual_v2\"\n}","options":{"response":{"response":{"responseFormat":"file"}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[880,-260],"id":"08c6c04a-b6d5-4f19-abfe-6f1622994ff3","name":"ElevenLabs TTS","credentials":{"elevenLabsApi":{"id":"JqMPEGEQyMA33Ztl","name":"ElevenLabs club"}}},{"parameters":{"content":"Voice ID: Every voice in ElevenLabs has a unique ID. You need to choose which voice your character will have and get its ID.\nHow to find it: Go to the \"Voice Lab\" in your ElevenLabs dashboard. Click \"Add Generative or Cloned Voice\" or select one of the pre-made voices. The Voice ID is a string of letters and numbers you can find in the API documentation or sometimes in the URL when you select a voice.\nExample: The popular pre-made voice \"Rachel\" has the ID 21m00Tcm4TlvDq8ikWAM","height":240,"width":400},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[780,-100],"id":"52b2492a-65d1-4ab5-bc99-c03a2cde32c7","name":"Sticky Note1"},{"parameters":{"method":"POST","url":"https://api.replicate.com/v1/predictions","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"version\": \"MODEL_VERSION_ID_GOES_HERE\",\n  \"webhook\": \"YOUR_N8N_WEBHOOK_URL_GOES_HERE\",\n  \"input\": {\n    // Model-specific parameters go here\n  }\n}```\n\n#### Filling in Each Key\n\n1.  **`version`**:\n    *   **What it is:** The specific version hash of the model you are running.\n    *   **How to find it:** On the model's \"API\" page on Replicate, it's listed right at the top. It's a long string of letters and numbers.\n    *   **Example Value:** `\"3aa3933a2410b7f41cf364100b531a0a035e1653a241f6758327161d0a143f79\"`\n\n2.  **`webhook`**:\n    *   **What it is:** The URL that Replicate will call when the video generation is complete. This URL points to your *Workflow #3*.\n    *   **How to construct it:** You need the webhook URL from Workflow #3 and you must append the user's `chat_id` as a query parameter so you know who to send the final video to.\n    *   **Action:**\n        1.  Go to your \"Result Delivery\" workflow and copy the Webhook URL.\n        2.  Come back to this node. In the `webhook` value, paste the URL and add `?chat_id=`.\n        3.  After the `=`, use an expression to get the chat ID from the very beginning of *this* workflow (from the ЮKassa webhook).\n    *   **Example Expression:** `https://your-n8n-instance.com/webhook/video-ready?chat_id={{ $node['Webhook'].json.body.object.metadata.chat_id }}`\n\n3.  **`input`**:\n    *   **What it is:** This is the object containing the parameters we found in Part 1.\n    *   **Action:** We will now fill in the parameters for our SadTalker example.\n\n    *   **`source_image`**: You need a public URL for the character image the user chose. You should store these URLs somewhere (e.g., in a `Set` node or a database table).\n        *   **Example:** Let's say you have a simple `IF` node that sets the URL based on `selected_character_id`. The expression might look like: `{{ $node['Set Character URL'].json.imageUrl }}`. For simplicity here, we can hardcode it.\n        *   **Value:** `\"https://i.imgur.com/example-character.png\"`\n\n    *   **`driven_audio`**: This is the public URL of the audio file you generated in the **new intermediate step (Node 5.5)**.\n        *   **Action:** Use an expression to get this URL from the output of that node.\n        *   **Example Expression:** `{{ $node['Upload Audio to Public URL'].json.link }}` (The exact path `.json.link` will depend on the service you use).\n\n    *   **Other parameters:** Add any other parameters from the model's API page that you want to control. If you omit them, Replicate will use their default values.\n        *   **Example:** `\"still_mode\": true`\n\n#### The Final `Body` Code Block\n\nPutting it all together, the complete text in your `Body` field will look like this. **This is your final template.**\n\n```json\n{\n  \"version\": \"3aa3933a2410b7f41cf364100b531a0a035e1653a241f6758327161d0a143f79\",\n  \"webhook\": \"https://your-n8n-instance.com/webhook/video-ready?chat_id={{ $node['Webhook'].json.body.object.metadata.chat_id }}\",\n  \"input\": {\n    \"source_image\": \"{{ $node['Set Character URL'].json.imageUrl }}\",\n    \"driven_audio\": \"{{ $node['Upload Audio to Public URL'].json.link }}\",\n    \"preprocess\": \"full\",\n    \"still_mode\": true\n  }\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1400,-260],"id":"bf815059-b8fc-4fe1-9856-ea309868558d","name":"Replicate Video Generation","credentials":{"httpHeaderAuth":{"id":"MrrEJOpy1E7t0Je4","name":"Replicate club"}}},{"parameters":{"method":"POST","url":"https://catbox.moe/user/api.php","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"reqtype","value":"fileupload"},{"parameterType":"formBinaryData","name":"fileToUpload"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1140,-260],"id":"74283515-e4fa-4d2d-82bb-8d55e897c3d0","name":"get file stored"}],"connections":{"When clicking ‘Execute workflow’":{"main":[[{"node":"If","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"If","type":"main","index":0}]]},"If":{"main":[[{"node":"Get All User Data","type":"main","index":0}]]},"Get All User Data":{"main":[[{"node":"Notify User","type":"main","index":0}]]},"Notify User":{"main":[[{"node":"ElevenLabs TTS","type":"main","index":0}]]},"ElevenLabs TTS":{"main":[[{"node":"get file stored","type":"main","index":0}]]},"get file stored":{"main":[[{"node":"Replicate Video Generation","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"versionId":"37365525-f85f-45be-8925-ec3e0b2c1a86","triggerCount":0,"shared":[{"updatedAt":"2025-10-16T18:52:34.136Z","createdAt":"2025-10-16T18:52:34.136Z","role":"workflow:owner","workflowId":"tyHNs8a7QwP3Sdwv","projectId":"zwyEtHn1PnfmNkEl"}],"tags":[]}
