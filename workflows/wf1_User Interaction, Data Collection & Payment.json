{"updatedAt":"2025-10-16T19:03:29.188Z","createdAt":"2025-10-16T18:12:40.533Z","id":"nlIIBp3aB9Wx5LsO","name":"wf1_User Interaction, Data Collection & Payment","active":false,"isArchived":false,"nodes":[{"parameters":{"updates":["message","callback_query","inline_query"],"additionalFields":{}},"type":"n8n-nodes-base.telegramTrigger","typeVersion":1.2,"position":[0,0],"id":"f617e620-58da-430f-b535-33ca133c240b","name":"Telegram Trigger","webhookId":"fa33efa8-d322-49ae-9b9e-981e515a3934","credentials":{"telegramApi":{"id":"FRssOlXEyxi0m4SO","name":"Telegram account"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.message.text }}","rightValue":"/start","operator":{"type":"string","operation":"startsWith"},"id":"c63fa70d-9276-4690-b05b-4767d0d753f6"}],"combinator":"and"},"renameOutput":true,"outputKey":"start"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"6fcc049c-dc86-429a-b2be-44c7ba9c7238","leftValue":"={{ $trigger.type  }}","rightValue":"callback_query","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"callback"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"4f031001-8fa9-41ab-971c-09aa2acce683","leftValue":"","rightValue":"","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"default"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[200,0],"id":"5b50ed21-e8fa-4de6-84da-4a751acb2e40","name":"Switch"},{"parameters":{"content":"## Table Name: user_sessions\nColumns:\nchat_id (INTEGER, PRIMARY KEY) - The user's unique Telegram chat ID.\nuser_state (TEXT) - The user's current stage (e.g., awaiting_character, awaiting_text, awaiting_payment).\nselected_character_id (TEXT) - The identifier for the chosen character.\nuser_text (TEXT) - The text provided by the user for the audio.\nlast_updated (DATETIME) - Timestamp of the last interaction.","height":280,"width":380},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-440,-140],"id":"f9bca0f0-69b6-4eab-ba99-928904b873a5","name":"Sticky Note"},{"parameters":{"chatId":"={{ $json.message.chat.id }}","text":"Добро пожаловать! Выберите персонажа, которого вы хотите анимировать.","replyMarkup":"inlineKeyboard","inlineKeyboard":{"rows":[{"row":{"buttons":[{"text":"Персонаж 1","additionalFields":{"callback_data":"char_select:char_1"}},{"text":"Персонаж 2","additionalFields":{"callback_data":"char_select:char_2"}}]}},{"row":{"buttons":[{"text":"Персонаж 3","additionalFields":{"callback_data":"char_select:char_3"}},{"text":"Персонаж 4","additionalFields":{"callback_data":"char_select:char_4"}}]}}]},"additionalFields":{"appendAttribution":false}},"type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[620,-120],"id":"ff311635-6794-4c1a-bf3c-284265c9bbf1","name":"Send Welcome & Character Choice","webhookId":"489b45bf-d7cc-4b85-941b-6887140f1f18","credentials":{"telegramApi":{"id":"FRssOlXEyxi0m4SO","name":"Telegram account"}}},{"parameters":{"operation":"executeQuery","query":"INSERT INTO user_sessions (chat_id, user_state, last_updated)\nVALUES ({{ $json.message.chat.id }}, 'awaiting_character', datetime('now'))\nON CONFLICT(chat_id) DO UPDATE SET\nuser_state = 'awaiting_character',\nlast_updated = datetime('now');","options":{"queryReplacement":""}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[420,-120],"id":"9228dfc6-0a8f-4e37-9c0b-3fb950ea51ad","name":"Create/Update User","credentials":{"postgres":{"id":"WKBw7lOCAQDUE20p","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"UPDATE user_sessions\nSET selected_character_id = '{{ $json.callback_query.data.split(':')[1] }}',\n    user_state = 'awaiting_text',\n    last_updated = datetime('now')\nWHERE chat_id = {{ $json.callback_query.message.chat.id }};","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[440,20],"id":"4a328c72-a00f-4503-aec4-1c0f2eb67010","name":"Update Character Choice","credentials":{"postgres":{"id":"WKBw7lOCAQDUE20p","name":"Postgres account"}}},{"parameters":{"chatId":"={{ $json.callback_query.message.chat.id }}","text":"Отличный выбор! Теперь, пожалуйста, отправьте мне текст, который должен произнести персонаж.","additionalFields":{}},"type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[640,40],"id":"72a9f70d-6642-4632-9c26-f5fe4ac44b2d","name":"Ask for Text","webhookId":"d1e88413-ac73-4a2c-8854-69de29bbdf85","credentials":{"telegramApi":{"id":"FRssOlXEyxi0m4SO","name":"Telegram account"}}},{"parameters":{"operation":"executeQuery","query":"SELECT user_state FROM user_sessions WHERE chat_id = {{ $json.message.chat.id }};","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[520,280],"id":"43fb9602-fdf1-4a5c-b461-592e9b64f8da","name":"Get User State","credentials":{"postgres":{"id":"WKBw7lOCAQDUE20p","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"a4ca5eed-c84e-447c-9832-4555ab39165f","leftValue":"={{ $json.user_state }}","rightValue":"awaiting_text","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[740,280],"id":"7f8fc279-570b-4d61-965d-b07192011ade","name":"Check if awaiting text"},{"parameters":{"operation":"executeQuery","query":"UPDATE user_sessions\nSET user_text = '{{ $json.message.text }}',\n    user_state = 'awaiting_payment'\nWHERE chat_id = {{ $json.message.chat.id }};","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[960,180],"id":"963f26ee-8947-477b-ba28-022cfd5605ca","name":"Save Text & Update State","credentials":{"postgres":{"id":"WKBw7lOCAQDUE20p","name":"Postgres account"}}},{"parameters":{"method":"POST","url":"https://api.yookassa.ru/v3/payments","sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"amount\": {\n    \"value\": \"100.00\",\n    \"currency\": \"RUB\"\n  },\n  \"confirmation\": {\n    \"type\": \"redirect\",\n    \"return_url\": \"https://t.me/your_bot_name\"\n  },\n  \"capture\": true,\n  \"description\": \"Генерация видео для персонажа\",\n  \"metadata\": {\n    \"chat_id\": \"{{ $json.message.chat.id }}\"\n  }\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1160,180],"id":"d953a0ee-ede1-4150-9261-c20e3c45eb77","name":"Create ЮKassa Payment"},{"parameters":{"content":"##  HTTP Request \nAuthentication: Basic\nUsername: Ваш shopId\nPassword: Ваш Секретный ключ\nBody (JSON):\ncode\nJSON\n{\n  \"amount\": {\n    \"value\": \"100.00\",\n    \"currency\": \"RUB\"\n  },\n  \"confirmation\": {\n    \"type\": \"redirect\",\n    \"return_url\": \"https://t.me/your_bot_name\"\n  },\n  \"capture\": true,\n  \"description\": \"Генерация видео по вашему тексту\",\n  \"metadata\": {\n    \"chatId\": \"{{ $node['Set'].json.chatId }}\",\n    \"userText\": \"{{ $node['Set'].json.userText }}\"\n  }\n}\nВажно: В metadata мы передаем chatId и текст. ЮKassa вернет их нам в вебхуке, и мы будем знать, какому пользователю и с каким текстом генерировать видео.","height":540,"width":380},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[1040,-380],"id":"e0df2164-b18a-4400-9ba9-21bf584322dc","name":"Sticky Note1"},{"parameters":{"chatId":"={{ $json.message.chat.id }}","text":"=Ваш заказ готов! Нажмите на кнопку ниже, чтобы перейти к оплате.","replyMarkup":"inlineKeyboard","inlineKeyboard":{"rows":[{"row":{"buttons":[{"text":"Оплатить 100 RUB","additionalFields":{"url":"={{ $json.confirmation.confirmation_url }}"}}]}}]},"additionalFields":{}},"type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[1460,180],"id":"6b3f7a04-d3e6-48cf-ad6f-13b2cf1f867d","name":"Send Payment Link","webhookId":"f2bd5f12-e208-42f1-9600-311743c9cabe","credentials":{"telegramApi":{"id":"FRssOlXEyxi0m4SO","name":"Telegram account"}}},{"parameters":{"content":"Sends the confirmation_url to the user.","height":100},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[1460,40],"id":"8975820f-bd43-458c-8c2e-fbb8133e1000","name":"Sticky Note2"}],"connections":{"Telegram Trigger":{"main":[[{"node":"Switch","type":"main","index":0}]]},"Switch":{"main":[[{"node":"Create/Update User","type":"main","index":0}],[{"node":"Update Character Choice","type":"main","index":0}],[{"node":"Get User State","type":"main","index":0}]]},"Create/Update User":{"main":[[{"node":"Send Welcome & Character Choice","type":"main","index":0}]]},"Update Character Choice":{"main":[[{"node":"Ask for Text","type":"main","index":0}]]},"Get User State":{"main":[[{"node":"Check if awaiting text","type":"main","index":0}]]},"Check if awaiting text":{"main":[[{"node":"Save Text & Update State","type":"main","index":0}]]},"Save Text & Update State":{"main":[[{"node":"Create ЮKassa Payment","type":"main","index":0}]]},"Create ЮKassa Payment":{"main":[[{"node":"Send Payment Link","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"versionId":"b3f9566c-42b5-4839-91ff-ce7fc3ca20d7","triggerCount":0,"shared":[{"updatedAt":"2025-10-16T18:12:40.533Z","createdAt":"2025-10-16T18:12:40.533Z","role":"workflow:owner","workflowId":"nlIIBp3aB9Wx5LsO","projectId":"zwyEtHn1PnfmNkEl"}],"tags":[]}